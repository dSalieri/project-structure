(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{10:function(e,t,n){"use strict";function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"a",(function(){return i}));class i{constructor(e,{duration:t=1e3,type:n="success"}={}){s(this,"element",void 0),this.message=e,this.duration=t,this.type=n,this.createElement()}get template(){return`\n      <div class="notification notification_${this.type}" style="--value:${this.duration/1e3}s">\n        <div class="notification__content notification__content_show">\n            ${this.message}\n        </div>\n      </div>\n    `}createElement(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild}show(e=document.body){i.activeMessage&&i.activeMessage.remove(),e.append(this.element),this.timerId=setTimeout(()=>{this.remove()},this.duration),i.activeMessage=this}remove(){clearTimeout(this.timerId),this.element&&this.element.remove()}destroy(){this.remove(),this.element=null,i.activeMessage=null}}s(i,"activeMessage",void 0)},13:function(e,t,n){"use strict";function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"a",(function(){return i}));class i{constructor({items:e}={}){s(this,"element",void 0),s(this,"elementPlaceholder",void 0),s(this,"elementDragging",void 0),s(this,"_props",{shiftDragging:{top:0,left:0},posPlaceholder:{top:0,left:0},posDragging:{top:0,left:0},initialIndex:-1,activeIndex:-1,isScrolling:!1,getTranslationDragging(e,t){const n=e.getBoundingClientRect(),s=t.getBoundingClientRect(),i=document.documentElement.scrollTop+n.top,r=document.documentElement.scrollLeft+n.left,o=document.documentElement.scrollTop+s.top;return`translate(${r-(document.documentElement.scrollLeft+s.left)}px,${i-o}px)`}}),s(this,"scrollIfCloseToWindowEdge",()=>{if(!this.elementDragging)return;const{top:e}=this._props.posDragging,t=e<15,n=document.documentElement.clientHeight<e+this.elementDragging.offsetHeight+15;t||n?(t&&window.scrollBy(0,-2),n&&window.scrollBy(0,2),this._props.isScrolling=!0,requestAnimationFrame(this.scrollIfCloseToWindowEdge)):this._props.isScrolling&&(this._props.isScrolling=!1)}),s(this,"onDragStart",e=>{if(!this.elementDragging&&e.target.closest("[data-grab-handle]")){e.preventDefault();const t=e.target.closest("li"),{width:n,height:s,top:i,left:r}=t.getBoundingClientRect();this._props.shiftDragging={top:e.clientY-i,left:e.clientX-r},this.elementPlaceholder.style.cssText=`\n        width: ${n}px;\n        height: ${s}px;\n      `,this.elementDragging=t,t.replaceWith(this.elementPlaceholder),this.elementDragging.classList.add("sortable-list__item_dragging"),this.elementDragging.style.cssText=`\n        user-select: none;\n        top: ${i}px;\n        left: ${r}px;\n        width: ${n}px;\n        height: ${s}px;\n      `;const{top:o,left:a}=this.elementPlaceholder.getBoundingClientRect();this._props.posPlaceholder={top:o,left:a},this.element.append(this.elementDragging),this._props.initialIndex=this.getIndex(),this._props.activeIndex=this._props.initialIndex,document.addEventListener("pointermove",this.onDragMove),document.addEventListener("pointerup",this.onDragEnd)}}),s(this,"onDragEnd",()=>{const e=this._props.getTranslationDragging(this.elementDragging,this.elementPlaceholder);this.elementDragging.classList.remove("sortable-list__item_dragging"),this.elementDragging.style.position="relative",this.elementDragging.style.zIndex=1e4,this.elementDragging.style.top="",this.elementDragging.style.left="",this.elementDragging.style.transform=e,this.elementDragging.style.transition="transform 0.3s ease-in-out",this.elementPlaceholder.replaceWith(this.elementDragging),setTimeout(()=>{this.elementDragging.style.transform="",this._props.isScrolling=!1,this.elementDragging=null},0),document.removeEventListener("pointermove",this.onDragMove),document.removeEventListener("pointerup",this.onDragEnd),this.elementDragging.addEventListener("transitionend",this.onTransitionEnd);const t=new CustomEvent("toggle-event",{detail:{element:this.element,changed:this._props.initialIndex!==this._props.activeIndex},bubbles:!0});this.elementDragging.dispatchEvent(t)}),s(this,"onDragMove",e=>{e.preventDefault(),this.elementDragging.style.display="none";const t=document.elementFromPoint(e.clientX,e.clientY)&&document.elementFromPoint(e.clientX,e.clientY).closest(".sortable-list")===this.element,n=document.elementFromPoint(e.clientX,e.clientY);if(this.elementDragging.style.display="",t&&n&&n.classList.contains("sortable-list__item")&&this.elementPlaceholder!==n){let{top:t,left:s}=n.getBoundingClientRect();this._props.posPlaceholder={top:t,left:s},this.elementPlaceholder.getBoundingClientRect().top-e.clientY<=0?n.after(this.elementPlaceholder):n.before(this.elementPlaceholder),this._props.activeIndex=this.getIndex()}this._props.posDragging={top:e.clientY-this._props.shiftDragging.top,left:e.clientX-this._props.shiftDragging.left},this.elementDragging.style.left=this._props.posDragging.left+"px",this.elementDragging.style.top=this._props.posDragging.top+"px",this._props.isScrolling||this.scrollIfCloseToWindowEdge()}),s(this,"onTransitionEnd",e=>{e.target.removeAttribute("style"),e.target.removeEventListener("transitionend",this.onTransitionEnd)}),s(this,"onRemoveItem",e=>{e.target.closest("[data-delete-handle]")&&e.target.closest("li").remove()}),s(this,"getIndex",()=>[...this.element.children].findIndex(e=>e===this.elementPlaceholder)),this.items=e,this.render()}get template(){const e=this.createHTMLElement('<ul class="sortable-list"></ul>');return this.items.forEach(t=>{t.classList.add("sortable-list__item"),e.append(t)}),e}get placeholder(){return this.createHTMLElement('<li class="sortable-list__placeholder"></li>')}render(){this.element=this.template,this.elementPlaceholder=this.placeholder,this.addEventListeners()}createHTMLElement(e){const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}addEventListeners(){this.element.addEventListener("pointerup",this.onRemoveItem),this.element.addEventListener("pointerdown",this.onDragStart)}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.element=null,this.elementPlaceholder=null,this.elementDragging=null,this._props=null}}},6:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return m}));var s=n(13),i=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),r=n(9);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const a="https://course-js.javascript.ru";class l{constructor(e){o(this,"element",void 0),o(this,"subElements",void 0),o(this,"defaultFormData",{title:"",description:"",quantity:1,subcategory:"",status:1,images:[],price:100,discount:0}),o(this,"onSubmit",e=>{e.preventDefault(),this.save()}),o(this,"uploadImage",()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.addEventListener("change",async()=>{const[t]=e.files;if(t){const n=new FormData,{uploadImage:s,imageListContainer:i}=this.subElements;n.append("image",t),s.classList.add("is-loading"),s.disabled=!0,console.log("28aaa2e823b03b1");const o=await Object(r.a)("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 28aaa2e823b03b1"},body:n});i.firstElementChild.append(this.getImageItem(o.data.link,t.name)),s.classList.remove("is-loading"),s.disabled=!1,e.remove()}}),e.click()}),this.productId=e}template(){return`\n      <div class="product-form">\n        <form data-element="productForm" class="form-grid">\n          <div class="form-group form-group__half_left">\n            <fieldset>\n              <label class="form-label">Name</label>\n              <input required\n                id="title"\n                value=""\n                type="text"\n                name="title"\n                class="form-control"\n                placeholder="Name">\n            </fieldset>\n          </div>\n          <div class="form-group form-group__wide">\n            <label class="form-label">Description</label>\n            <textarea required\n              id="description"\n              class="form-control"\n              name="description"\n              data-element="productDescription"\n              placeholder="Description"></textarea>\n          </div>\n          <div class="form-group form-group__wide">\n            <label class="form-label">Images</label>\n            <div data-element="imageListContainer"></div>\n            <button data-element="uploadImage" type="button" class="button-primary-outline">\n              <span>Upload</span>\n            </button>\n          </div>\n          <div class="form-group form-group__half_left">\n            <label class="form-label">Category</label>\n              ${this.createCategoriesSelect()}\n          </div>\n          <div class="form-group form-group__half_left form-group__two-col">\n            <fieldset>\n              <label class="form-label">Price ($)</label>\n              <input required\n                id="price"\n                value=""\n                type="number"\n                name="price"\n                class="form-control"\n                placeholder="${this.defaultFormData.price}">\n            </fieldset>\n            <fieldset>\n              <label class="form-label">Discount ($)</label>\n              <input required\n                id="discount"\n                value=""\n                type="number"\n                name="discount"\n                class="form-control"\n                placeholder="${this.defaultFormData.discount}">\n            </fieldset>\n          </div>\n          <div class="form-group form-group__part-half">\n            <label class="form-label">Count</label>\n            <input required\n              id="quantity"\n              value=""\n              type="number"\n              class="form-control"\n              name="quantity"\n              placeholder="${this.defaultFormData.quantity}">\n          </div>\n          <div class="form-group form-group__part-half">\n            <label class="form-label">Status</label>\n            <select id="status" class="form-control" name="status">\n              <option value="1">Active</option>\n              <option value="0">Inactive</option>\n            </select>\n          </div>\n          <div class="form-buttons">\n            <button type="submit" name="save" class="button-primary-outline">\n              ${this.productId?"Save":"Add"} product\n            </button>\n          </div>\n        </form>\n      </div>\n    `}async render(){const e=this.loadCategoriesList(),t=this.productId?this.loadProductData(this.productId):[this.defaultFormData],[n,s]=await Promise.all([e,t]),[i]=s;return this.formData=i,this.categories=n,this.renderForm(),this.formData&&(this.setFormData(),this.createImageList(),this.initEventListeners()),this.element}async save(){const e=this.getFormData();try{const t=await Object(r.a)(a+"/api/rest/products",{method:this.productId?"PATCH":"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});this.dispatchEvent(t.id)}catch(e){console.error("Unknown error",e)}}getFormData(){const{productForm:e,imageListContainer:t}=this.subElements,n=["images"],s=["price","quantity","discount","status"],i=Object.keys(this.defaultFormData).filter(e=>!n.includes(e)),r=t=>e.querySelector(`[name=${t}]`).value,o={};for(const e of i){const t=r(e);o[e]=s.includes(e)?parseInt(t):t}const a=t.querySelectorAll(".sortable-table__cell-img");o.images=[],o.id=this.productId;for(const e of a)o.images.push({url:e.src,source:e.alt});return o}setFormData(){const{productForm:e}=this.subElements,t=["images","subcategory"];Object.keys(this.defaultFormData).filter(e=>!t.includes(e)).forEach(t=>{e.querySelector("#"+t).value=this.formData[t]||this.defaultFormData[t]})}renderForm(){const e=document.createElement("div");e.innerHTML=this.formData?this.template():this.getEmptyTemplate(),this.element=e.firstElementChild,this.subElements=this.getSubElements(e)}getEmptyTemplate(){return'\n      <div>\n        <h1 class="page-title">Страница не найдена</h1>\n        <p>Извините, данный товар не существует</p>\n      </div>\n    '}async loadCategoriesList(){return Object(r.a)(a+"/api/rest/categories?_sort=weight&_refs=subcategory")}async loadProductData(e){return Object(r.a)(`${a}/api/rest/products?id=${e}`)}createCategoriesSelect(){const e=document.createElement("div");e.innerHTML='<select class="form-control" id="subcategory" name="subcategory"></select>';const t=e.firstElementChild;for(const e of this.categories)for(const n of e.subcategories)t.append(new Option(`${e.title} > ${n.title}`,n.id));return t.outerHTML}createImageList(){const{imageListContainer:e}=this.subElements,{images:t}=this.formData,n=t.map(({url:e,source:t})=>this.getImageItem(e,t)),i=new s.a({items:n});e.append(i.element)}getImageItem(e,t){const n=document.createElement("div");return n.innerHTML=`\n    <li class="products-edit__imagelist-item sortable-list__item">\n      <span>\n        <img src="../icons/icon-grab.svg" data-grab-handle alt="grab">\n        <img class="sortable-table__cell-img" alt="${i(t)}" src="${i(e)}">\n        <span>${i(t)}</span>\n      </span>\n      <button type="button">\n        <img src="../icons/icon-trash.svg" alt="delete" data-delete-handle>\n      </button>\n    </li>\n    `,n.firstElementChild}getSubElements(e){const t={},n=e.querySelectorAll("[data-element]");for(const e of n)t[e.dataset.element]=e;return t}dispatchEvent(e){const t=this.productId?new CustomEvent("product-updated",{detail:e,bubbles:!0}):new CustomEvent("product-saved",{bubbles:!0});this.element.dispatchEvent(t)}initEventListeners(){const{productForm:e,uploadImage:t}=this.subElements;e.addEventListener("submit",this.onSubmit),t.addEventListener("click",this.uploadImage)}remove(){this.element.remove()}destroy(){this.remove(),this.element=null,this.subElements=null}}var c=n(10);function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class m{constructor(e){d(this,"element",void 0),d(this,"subElements",{}),d(this,"components",{}),this.match=e}async initComponents(){const e=new l(this.match&&this.match[1]);await e.render(),this.components={editableForm:e}}renderComponents(){Object.keys(this.components).forEach(e=>{const t=this.subElements[e],{element:n}=this.components[e];n&&t.append(n)})}get template(){return`\n      <div class="products-edit">\n        <div class="content__top-panel">\n          <h1 class="page-title">\n            <a href="/products" class="link">Products</a> / ${this.match&&this.match[1]?"Edit":"Add"}\n          </h1>\n        </div>\n        <div data-element="editableForm" class="content-box"></div>\n      </div>\n    `}async render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),await this.initComponents(),this.renderComponents(),this.initEventListeners(),this.element}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}initEventListeners(){document.addEventListener("product-updated",()=>{new c.a("Changes have been applied successfully",{duration:3e3,type:"success"}).show()}),document.addEventListener("product-saved",()=>{new c.a("Product has been created successfully",{duration:3e3,type:"success"}).show()})}remove(){this.element&&this.element.remove()}destroy(){this.remove();for(const e of Object.values(this.components))e.destroy()}}},9:function(e,t,n){"use strict";var s=n(10);t.a=async function(e,t){let n,s;try{n=await fetch(e.toString(),t)}catch(e){throw new i(n,"Network error has occurred.")}if(!n.ok){let e=n.statusText;try{s=await n.json(),e=s.error&&s.error.message||s.data&&s.data.error&&s.data.error.message||e}catch(e){}let t=`Error ${n.status}: ${e}`;throw new i(n,s,t)}try{return await n.json()}catch(e){throw new i(n,null,e.message)}};class i extends Error{constructor(e,t,n){var s,i,r;super(n),r="FetchError",(i="name")in(s=this)?Object.defineProperty(s,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):s[i]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{if(e.reason instanceof i){new s.a(e.reason.message,{duration:3e3,type:"error"}).show()}})}}]);
//# sourceMappingURL=products-edit-index-js-4.js.map